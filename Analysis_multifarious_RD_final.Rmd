---
title: "Multifarious response diversity experiments"
author: "Francesco Polazzo, to be added"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: hide
    keep_md: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE)
```

```{r results='hide'}
rm(list = ls())
library(plotly)
library(tidyverse)
library(here)
library(patchwork)
library(DT)
library(mgcv)
library(gratia)
library(rlang)
library(vctrs)
library(scales)
library(broom)
library(reshape2)
library(ggtext)
library(ggsci)
library(ggpubr)
source.files <- list.files(here("r"), full.names = TRUE)
sapply(source.files, source, .GlobalEnv)

theme_set(theme_classic())
```
# Intention 

The goal of this document is to calculate the growth rate (r) and the carrying capacity (K) of 6 species of ciliates 
that we grew individually in a replicated (n = 3) factorial experiment with 5 temperatures (18, 21, 24, 26, and 28), 5 nutrients levels and their combinations (= 25 treatments) for 3 weeks. 
The calculated r and K are then going to be used as the traits to calculate potential response diversity of communities composed of 2, 3, and 4 species to all possible changes in temperature and nutrients. The calculated potential response diversity will inform us on which communities will be used in the following experimental step.
We are going to calculate the growth rate as the slope of the regression of ln(Nt) where: ln is natural log and Nt is the population density at time t, during the period of exponential growth. 
We are going to set initially the period of exponential growth as the first 6 days, but we are going to visually check whether this choice is correct. 
K will be calculated as the highest population biomass for each population during the experiment.


Let's start loading the data set and creating a subset for calculating r
```{r}
dd <- read.csv(here("Data/data_reaction_norms.csv"))
names(dd)
dd1 <- dd %>% select("species", "temperature", "nutrients", "sample_ID", "density", "day")
# create a data frame with only the days of exponential growth (first 6 days)
dd_d6 <- dd %>% filter(day <= 6) 


str(dd1)
```

```{r}
# Assuming dd1 is your original data frame
# First, let's create day_0_data with the appropriate density values for day = 0
# Load required packages
library(dplyr)

# Assuming your original data frame is named dd1
# Create a data frame for day == 0 with the same structure as dd1
day_0_data <- data.frame(
  species = rep(unique(dd1$species), each = nrow(dd1)),  # Replicate for all species
  temperature = NA,  # Initialize with NA
  nutrients = NA,    # Initialize with NA
  sample_ID = NA,    # Initialize with NA
  density = ifelse(dd1$species %in% c("Colpidium", "Dexiostoma", "Loxocephalus"), 100, 25),  # Set density values as specified
  day = rep(0, nrow(dd1) * length(unique(dd1$species)))  # Set day = 0 for all rows
)

day_1_values <- subset(dd1, day == 1)[1, c("temperature", "nutrients", "sample_ID")]

# Create a new data frame for day == 0 with the same structure as dd1
day_0_data <- data.frame(
  species = rep(unique(dd1$species), each = nrow(dd1)),  # Replicate for all species
  temperature = rep(day_1_values$temperature, nrow(dd1) * length(unique(dd1$species))),
  nutrients = rep(day_1_values$nutrients, nrow(dd1) * length(unique(dd1$species))),
  sample_ID = rep(day_1_values$sample_ID, nrow(dd1) * length(unique(dd1$species))),
  density = ifelse(dd1$species %in% c("Colpidium", "Dexiostoma", "Loxocephalus"), 100, 25),  # Set density values as specified
  day = rep(0, nrow(dd1) * length(unique(dd1$species)))
)

# Combine day_0_data with dd1
combined_data <- rbind(dd1, day_0_data)


combined_data %>% filter(day == 0)
```



```{r time_series_spp, fig.cap= 'Time series of species densities across the treatments.', fig.align="center", fig.height=20, fig.width=30}

# plot sp densities over time
ggplot(dd, aes(x = day, y = log(density), color = as.factor(nutrients))) +
  geom_point(size = 2) +
  geom_smooth(method = "loess", se = FALSE, linewidth = 2) +
  scale_color_viridis_d(option = "magma") +
  facet_grid(temperature ~ species) +
  theme_bw() +
  scale_x_continuous(breaks = seq(min(dd$day), max(dd$day), by = 1)) +
  theme(
    # Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
     # Increase legend text and title size
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 20),
    # Increase legend key size
    legend.key.size = unit(2, "lines")  # Adjust the size as needed
  )
  

# Spirostomum took longer than the other species to start growing. Try to calculate r over the whole experimental time
```


    m,     ,           h                     00## Calculate K and r 
```{r}
# Group the data by species, nutrient level, temperature, and sample ID
grouped_data <- dd %>%
  group_by(species, nutrients, temperature, sample_ID) 

### Calculate carrying capacity (K) as the highest population density for each species and treatment 

carrying_capacity_df <- grouped_data %>%
  summarise(
    CarryingCapacity = max(density),
    .groups = 'drop'
  )


### Calculate growth rate as the slope of the linear regression of density ~ time for each species and treatment combination

grouped_data_d6 <- dd_d6 %>%
  group_by(species, nutrients, temperature, sample_ID) %>% 
  filter(species != "Spirostomum")

grouped_data_d6 <- grouped_data_d6 %>% filter(!(species %in% c("Colpidium", "Loxocephalus") & temperature == 28))

growth_rates_df <- grouped_data_d6 %>%
  summarise(
    Intercept = coef(lm(log(density + 0.001) ~ day))[1],
    GrowthRate = coef(lm(log(density + 0.001) ~ day))[2],
    RSquared = summary(lm(log(density + 0.001) ~ day))$r.squared,
    .groups = 'drop'
  )


spiro_r_df <- dd %>% filter(species == "Spirostomum") %>% 
  group_by(species, nutrients, temperature, sample_ID) 
  
  spiro_r <-  spiro_r_df %>%
  summarise(
    Intercept = coef(lm(log(density + 0.001) ~ day))[1],
    GrowthRate = coef(lm(log(density + 0.001) ~ day))[2],
    RSquared = summary(lm(log(density + 0.001) ~ day))$r.squared,
    .groups = 'drop'
  )
  


colp_28 <- dd %>% filter((species %in% "Colpidium" & temperature == 28)) %>% 
  filter(day <= 3) %>% 
  group_by(species, nutrients, temperature, sample_ID) 
  
colp_28_r <- colp_28 %>% summarise(
    Intercept = coef(lm(log(density + 0.001) ~ day))[1],
    GrowthRate = coef(lm(log(density + 0.001) ~ day))[2],
    RSquared = summary(lm(log(density + 0.001) ~ day))$r.squared,
    .groups = 'drop'
  )


loxo_28 <- dd %>% filter((species %in% "Loxocephalus" & temperature == 28)) %>% 
  filter(day <= 3) %>% 
  group_by(species, nutrients, temperature, sample_ID) 
  
loxo_28_r <- loxo_28 %>% summarise(
    Intercept = coef(lm(log(density + 0.001) ~ day))[1],
    GrowthRate = coef(lm(log(density + 0.001) ~ day))[2],
    RSquared = summary(lm(log(density + 0.001) ~ day))$r.squared,
    .groups = 'drop'
  )
    
growth_rates_df <- rbind(growth_rates_df, spiro_r, loxo_28_r, colp_28_r)

# Display the resulting carrying capacity and growth rate data frames
dd_r_K <- merge(growth_rates_df, carrying_capacity_df, by = c("species", "nutrients", "temperature", "sample_ID"))

dd_r_K_1<-mutate(filter(dd_r_K,nutrients==1),nutrients=0.01)
dd_r_K_2<-mutate(filter(dd_r_K,nutrients==2),nutrients=0.75)
dd_r_K_3<-mutate(filter(dd_r_K,nutrients==3),nutrients=1.25)
dd_r_K_4<-mutate(filter(dd_r_K,nutrients==4),nutrients=2.5)
dd_r_K_5<-mutate(filter(dd_r_K,nutrients==5),nutrients=3)

dd_r_K_new<-rbind(dd_r_K_1,dd_r_K_2,dd_r_K_3,dd_r_K_4,dd_r_K_5)
dd_r_K<-dd_r_K_new
```


Visual inspection of exponential growth phase 
```{r}
# List to store ggplot objects
ggplot_objects <- list()
# Loop through each species
for (species_name in unique(dd$species)) {
  
  # Filter data for the current species
  subset_data <- dd %>%
    filter(species == species_name)
  
  # Create ggplot object
  ggplot_object <- ggplot(subset_data, aes(x = day, y = log(density + 0.001), color = as.factor(nutrients))) +
    geom_point(data = subset_data, aes(x = day, y = log(density + 0.001), color = as.factor(nutrients))) +
    geom_smooth(data = subset_data, method = "loess", se = FALSE) +
    geom_smooth(data = subset_data %>% filter(day <= 6), method = "lm", se = FALSE, aes(group = nutrients, color = factor(nutrients)), linewidth = 1.5) +  # Add LM line
    scale_color_viridis_d(option = "magma") +
    facet_wrap(~temperature, scales = "free") +
    theme_bw() +
    scale_x_continuous(breaks = seq(min(dd$day), max(dd$day), by = 1)) +
    ggtitle(paste("Species:", species_name))
  
  # Save the ggplot object in the listÂ§
  ggplot_objects[[species_name]] <- ggplot_object
}

# Access a specific plot, for example, Dexiostoma
dexiostoma_plot <- ggplot_objects[["Dexiostoma"]]
colpidium_plot <- ggplot_objects[["Colpidium"]]
loxocephalus_plot <- ggplot_objects[["Loxocephalus"]]
paramecium_plot <- ggplot_objects[["Paramecium"]]
#spirostomum_plot <- ggplot_objects[["Spirostomum"]]
tetrahymena_plot <- ggplot_objects[["Tetrahymena"]]
# Display the plot
# dexiostoma_plot # probably we can go to day 6 for Dexio
# colpidium_plot
# loxocephalus_plot
# paramecium_plot
# spirostomum_plot
# tetrahymena_plot

# Create ggplot object

plot_regression_day <- ggplot(dd, aes(x = day, y = log(density), color = as.factor(nutrients))) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE) +
  geom_smooth(data = dd %>% filter(day <= 6, species != "Spirostomum"), method = "lm", se = FALSE, aes(group = nutrients, color = factor(nutrients)), linewidth = 1.5) +  # LM line for days <= 5
  geom_smooth(data = dd %>% filter(species == "Spirostomum"), method = "lm", se = FALSE, aes(group = nutrients, color = factor(nutrients)), linewidth = 1.5) +  # LM line for Spirostomum across all days
  scale_color_viridis_d(option = "magma") +
  facet_grid(temperature~ species, scales = "free") +
  theme_bw() +
  scale_x_continuous(breaks = seq(min(dd$day), max(dd$day), by = 1)) +
   theme(
    # Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
     # Increase legend text and title size
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 20),
    # Increase legend key size
    legend.key.size = unit(2, "lines")  # Adjust the size as needed
  )

```


```{r, warning=FALSE, reg_all, fig.cap='Species densities across the treatments with the regression lines used to calculate the intrinsic rate of growth (r).', fig.align="center", fig.height=15, fig.width=20}


plot_regression_day
```

## GAMs to fit responde surface 

At least for now, we focus on the intrinsic rate of growth (r). We are going to fit response surfaces using the calculated r for all species using GAMs. Then we are also going to use r as the species' trait to calculate potential response diversity, as well as response diversity when the direction of the environmental change is known. The rationale is that r is likely of more relevance if the environmental change of interest occurs rapidly, since r provides information on a population's ability to rapidly bounce back after disturbance. In the upcoming experiment, we will have temperature fluctuating relatively fast, and so we decide now to focus on r. 

Use GAMs to fit response surface of r and K 
```{r}
# Fit GAMS to calculated growth rate to estimate response surface

new_data <- expand_grid(temperature = seq(18, 28, by= 0.02),
                        nutrients = seq(0.01, 3, by= 0.01))


nested_gams <- dd_r_K %>% 
  nest(cols =-species) %>% 
  mutate(
    gams = map(cols, ~ gam(GrowthRate ~ te(temperature, nutrients, k = c(5, 5)),
                           data = .x,
                           method = "REML")),
    predicted = map(gams, ~ predict(.x, newdata = new_data))
  )

# Get gams coefficients
coeff <- nested_gams %>% 
  mutate(coefs = map(gams, tidy, conf.int = TRUE)) %>% 
  unnest(coefs) %>% 
  dplyr::select(c('species', 'term', 'p.value'))



# Get gams glance
# nested_gams %>% 
#   mutate(results = map(gams, glance), 
#          R.square = map_dbl(gams, ~ summary(.)$r.sq))  %>% 
#   unnest(results) 


# Creating the dataset with the 2 columns as described above
predicted <- nested_gams %>% unnest(predicted)
rates <- cbind(new_data, predicted[, c(1,4)])
rates <- rates %>%
  relocate(species, temperature, nutrients, predicted)


```


```{r results='asis', message=FALSE, warning=FALSE}
## Display the parameter table
head(rates,
              filter="top")
```



Create surface plots
```{r}

# Create a list to store ggplot objects
surface_plots <- list()

# Loop through each species and draw GAM surface
for (i in seq_along(nested_gams$gams)) {
  species_name <- nested_gams$species[i]
  gam_model <- nested_gams$gams[[i]]
  
  # Create a new plot for each species
  plot <- ggplot(rates %>% filter(species == species_name),
                 aes(x = temperature, y = nutrients, z = predicted)) +
    geom_tile(aes(fill = predicted), color = "white") +
    geom_contour(color = "black", linetype = "solid", breaks = seq(-1, 1, by = 0.1), n = 10) +  
    scale_fill_viridis_c() +
    labs(title = paste("GAM Surface for", species_name),
         fill = "Predicted Growth Rate") +
    theme_bw() +
    scale_x_continuous(breaks = c(18, 21, 24, 26, 28))
  
  # Save the plot in the list
  surface_plots[[species_name]] <- plot
  
}
```


We now check how the GAMs surfaces (r) look compared to the measured densities.
```{r}
# Access a specific plot, for example, Dexiostoma
surface_dexiostoma <- surface_plots[["Dexiostoma"]]
surface_colpidium <- surface_plots[["Colpidium"]]
surface_loxocephalus <- surface_plots[["Loxocephalus"]]
surface_paramecium <- surface_plots[["Paramecium"]]
surface_spirostotum <- surface_plots[["Spirostomum"]]
surface_tetrahymena <- surface_plots[["Tetrahymena"]]


Dexiostoma <- filter(nested_gams, species == "Dexiostoma")
surface_dexiostoma + draw(Dexiostoma$gams[[1]], rug = FALSE, dist = 0.5)


# Checking predictions
# dexiostoma_plot + surface_dexiostoma
# colpidium_plot + surface_colpidium
# loxocephalus_plot + surface_loxocephalus
# paramecium_plot + surface_paramecium ### Paramecium seems to take longer to get to stable phase. Maybe do regression day 8
# spirostomum_plot + surface_spirostotum ### Remove day 11 nutrients 2 temperature 28 
# tetrahymena_plot + surface_tetrahymena

```
Checking predictions
```{r surface_Dexi, fig.cap='Measured density values of Dexiostoma in the different treatments (a) vs fitted surface of growth rate (b).', fig.align="center", fig.height=12, fig.width=25}
dexiostoma_plot <- dd_r_K %>% filter(species == "Dexiostoma") %>% 
  ggplot(aes(x = nutrients, y = GrowthRate, color = as.factor(nutrients))) +
  geom_point(size = 3.5, position = position_jitterdodge(jitter.width = 0.5, dodge.width = 0.4)) + 
  facet_grid(~temperature) +
  theme_bw() +
  theme(
    # Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
  ) +
  scale_color_viridis_d(option = "magma") +
  labs(tag = "(a)")
  
surface_dexiostoma <- surface_dexiostoma + labs(tag = "(b)")
dexiostoma_plot + surface_dexiostoma
```


```{r surface_colp, fig.cap='Measured density values of Colpidium in the different treatments (a) vs fitted surface of growth rate (b).', fig.align="center", fig.height=12, fig.width=25}
colpidium_plot <- dd_r_K %>% filter(species == "Colpidium") %>% 
  ggplot(aes(x = nutrients, y = GrowthRate, color = as.factor(nutrients))) +
  geom_point(size = 3.5, position = position_jitterdodge(jitter.width = 0.5, dodge.width = 0.4)) + 
  facet_grid(~temperature) +
  theme_bw() +
  theme(
    # Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
  ) +
  scale_color_viridis_d(option = "magma") +
  labs(tag = "(a)")
surface_colpidium <- surface_colpidium + labs(tag = "(b)")
colpidium_plot + surface_colpidium
```



```{r surface_loxo, fig.cap='Measured density values of Loxocephalus in the different treatments (a) vs fitted surface of growth rate (b).', fig.align="center", fig.height=12, fig.width=25}
loxocephalus_plot <- dd_r_K %>% filter(species == "Loxocephalus") %>% 
  ggplot(aes(x = nutrients, y = GrowthRate, color = as.factor(nutrients))) +
  geom_point(size = 3.5, position = position_jitterdodge(jitter.width = 0.5, dodge.width = 0.4)) + 
  facet_grid(~temperature) +
  theme_bw() +
  theme(
    # Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
  ) +
  scale_color_viridis_d(option = "magma") +
  labs(tag = "(a)")

surface_loxocephalus <- surface_loxocephalus + labs(tag = "(b)")
loxocephalus_plot + surface_loxocephalus
```


```{r surface_paramecium, fig.cap='Measured density values of Paramecium in the different treatments (a) vs fitted surface of growth rate (b).', fig.align="center", fig.height=12, fig.width=25}
paramecium_plot <- dd_r_K %>% filter(species == "Paramecium") %>% 
  ggplot(aes(x = nutrients, y = GrowthRate, color = as.factor(nutrients))) +
  geom_point(size = 3.5, position = position_jitterdodge(jitter.width = 0.5, dodge.width = 0.4)) + 
  facet_grid(~temperature) +
  theme_bw() +
  theme(
    # Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
  ) +
  scale_color_viridis_d(option = "magma") +
  labs(tag = "(a)")
surface_paramecium <- surface_paramecium + labs(tag = "(b)")
paramecium_plot + surface_paramecium
```

```{r surface_spiro, fig.cap='Measured density values of Spirostotum in the different treatments (a) vs fitted surface of growth rate (b).', fig.align="center", fig.height=12, fig.width=25}
surface_spirostotum <- surface_spirostotum + labs(tag = "(b)") 
spirostomum_plot <- dd_r_K %>% filter(species == "Spirostomum") %>% 
  ggplot(aes(x = nutrients, y = GrowthRate, color = as.factor(nutrients))) +
  geom_point(size = 3.5, position = position_jitterdodge(jitter.width = 0.5, dodge.width = 0.4)) + 
  facet_grid(~temperature) +
  theme_bw() +
  theme(
    # Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
  ) +
  scale_color_viridis_d(option = "magma") +
  labs(tag = "(a)")
spirostomum_plot + surface_spirostotum
```


```{r surface_tetra, fig.cap='Measured density values of Tetrahymena in the different treatments (a) vs fitted surface of growth rate (b).', fig.align="center", fig.height=12, fig.width=25}
tetrahymena_plot <- dd_r_K %>% filter(species == "Tetrahymena") %>% 
  ggplot(aes(x = nutrients, y = GrowthRate, color = as.factor(nutrients))) +
  geom_point(size = 3.5, position = position_jitterdodge(jitter.width = 0.5, dodge.width = 0.4)) + 
  facet_grid(~temperature) +
  theme_bw() +
  theme(
    # Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
  ) +
  scale_color_viridis_d(option = "magma") +
  labs(tag = "(a)")
surface_tetrahymena <- surface_tetrahymena + labs(tag = "(b)")
tetrahymena_plot + surface_tetrahymena
```

# Calculate Potential Response diversity 
After discussion, we decided to remove Tetrahymena


Now, we calculate potential response diversity for all possible communities composed of 2, 3, and 4 species.
We start with all communities composed of 2 species.

## Potential response diversity 2 species communities 
Steps are:

- Create ref environmental conditions
```{r}
refs2 <- crossing(temperature = seq(from = 18, to = 28, length.out = 10),
                  nutrients = seq(from = 1, to = 5, length.out = 10))

```

- Create all possible communities with 2 species
```{r}
all_species <- c("Colpidium", "Dexiostoma", "Loxocephalus", "Paramecium", "Spirostomum")
# Create all possible combinations of 2 species names
all_combinations_2species <- combn(c("Colpidium", "Dexiostoma", "Loxocephalus", "Paramecium", "Spirostomum"), 2, simplify = TRUE)
```


- Calculate potential response diversity for all communities richness = 2 with our function "get_potential_RD"

```{r, warning=FALSE}

# Use lapply to iterate through each pair
# get_potential_RD <- function(species_names, nested_gams, E1_var, E2_var)  
# specify variables names for the "get_potential_RD" function
E1_var <- "temperature"
E2_var <- "nutrients"
result_list_2species <- lapply(1:ncol(all_combinations_2species), function(i) {
  E1_var <- "temperature"
  E2_var <- "nutrients"
  species_names <- all_combinations_2species[, i]
  result <- get_potential_RD(species_names, nested_gams, E1_var, E2_var)
  return(result)
})

# Combine all data frames into a single data frame
final_result_2species <- do.call(rbind, result_list_2species)

# Add a new column "composition" with the initial letters of species1 and species2
final_result_2species <- final_result_2species %>%
 mutate(composition = map_chr(row_number(), ~ paste0(substr(all_combinations_2species[, .], 1, 1), collapse = "")))%>% 
  mutate(richness = 2)
# Print the updated final result
#print(final_result_2species)

```

Results
```{r results='asis', message=FALSE, warning=FALSE}
## Display the parameter table
head(final_result_2species,
              filter="top")
```

## Potential Response Diversity 3 species communities
```{r}
# Generate all possible combinations of 3 species names
combinations_3species <- combn(all_species, 3, simplify = TRUE)

# specify variables names for the "get_potential_RD" function
E1_var <- "temperature"
E2_var <- "nutrients"
# Use lapply to iterate through each pair
result_list_3species <- lapply(1:ncol(combinations_3species), function(i) {
  species_names <- combinations_3species[, i]
  result <- get_potential_RD(species_names, nested_gams, E1_var, E2_var)
  return(result)
})


# Combine all data frames into a single data frame
result_list_3species <- do.call(rbind, result_list_3species)

# Add a new column "composition" with the initial letters of species1 and species2
result_list_3species <- result_list_3species %>%
  mutate(composition = map_chr(strsplit(species, "_"), ~ paste0(substr(., 1, 1), collapse = "")))%>% 
  mutate(richness = 3)
# Print the updated final result
#print(result_list_3species)

```

Results
```{r results='asis', message=FALSE, warning=FALSE}
## Display the parameter table
head(result_list_3species,
              filter="top")
```


## Potential Response Diversity 4 species communities 
```{r}
# Generate all possible combinations of 4 species names
combinations_4species <- combn(all_species, 4, simplify = TRUE)

# specify variables names for the "get_potential_RD" function
E1_var <- "temperature"
E2_var <- "nutrients"
# Use lapply to iterate through each pair
result_list_4species <- lapply(1:ncol(combinations_4species), function(i) {
  species_names <- combinations_4species[, i]
  result <- get_potential_RD(species_names, nested_gams, E1_var, E2_var)
  return(result)
})


# Combine all data frames into a single data frame
result_list_4species <- do.call(rbind, result_list_4species)

# Add a new column "composition" with the initial letters of species1 and species2
result_list_4species <- result_list_4species %>%
  mutate(composition = map_chr(strsplit(species, "_"), ~ paste0(substr(., 1, 1), collapse = ""))) %>% 
  mutate(richness = 4)
# Print the updated final result
#print(result_list_4species)

```

Results

```{r results='asis', message=FALSE, warning=FALSE}
## Display the parameter table
head(result_list_4species,
              filter="top")
```

<!-- Merging data frames and getting community compositions with the highest, lowest and intermediates potential response diversity for each diversity level.  -->
```{r}
# merge data frames
potential_RD <- rbind(final_result_2species, result_list_3species, result_list_4species)

# 
# 
# reshaped_potential_RD <- potential_RD %>%
#   pivot_longer(cols = c(dissimilarity, divergence),
#                names_to = "response_diversity",
#                values_to = "values")
# 
# 
# 
# # Find rows with the highest and lowest values of response diversity
# highest_values <- reshaped_potential_RD %>%
#   group_by(richness, response_diversity) %>%
#   filter(values == max(values)) %>%
#   ungroup()
# 
# 
# lowest_values <- reshaped_potential_RD %>%
#   group_by(richness, response_diversity) %>%
#   filter(values == min(values)) %>%
#   ungroup()
# 
# # Calculate the median value of response diversity within each richness level
# median_values <- reshaped_potential_RD %>%
#   group_by(richness, response_diversity) %>%
#   summarize(median_value = median(values))
# 
# # Find the rows with response diversity values closest to the median
# median_compositions <- reshaped_potential_RD %>%
#   group_by(richness, response_diversity) %>%
#   mutate(diff_from_median = abs(values - median_values$median_value)) %>%
#   filter(diff_from_median == min(diff_from_median)) %>%
#   ungroup()
# 
# ranked_potential_RD_df <- rbind(highest_values, median_compositions, lowest_values)

```
<!-- Results -->
<!-- ```{r results='asis', message=FALSE, warning=FALSE} -->
<!-- ## Display the parameter table -->
<!-- head(ranked_potential_RD_df, -->
<!--               filter="top") -->
<!-- ``` -->

```{r potential_RD_plot, fig.cap='Potential Response diversity per species richness measured as dissimilarity (a) and divergence (b).', fig.align="center", fig.height=8, fig.width=15}
potential_divergence_plot <- potential_RD %>% 
  ggplot(aes(x = richness, y = divergence)) +
  geom_point(size = 1.5) +
  geom_text(aes(label = composition), vjust = -0.5, size = 4) +
  theme_bw() + scale_x_continuous(breaks = c(2, 3, 4))  +
  labs(tag = "(b)") +
   theme(
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20))

potential_dissimilarity_plot <- potential_RD %>% 
  ggplot(aes(x = richness, y = dissimilarity)) +
  geom_point(size = 1.5) +
  geom_text(aes(label = composition), vjust = -0.5, size = 4) +
  theme_bw() + scale_x_continuous(breaks = c(2, 3, 4)) +
  labs(tag = "(a)") +
   theme(
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20))

potential_dissimilarity_plot + potential_divergence_plot

```


# Response diversity with known direction of environmental change

Now we calculate RD with known direction of environmental change, i.e. the ones we are going to apply in the experiment. We are going to calculate response diversity for multiple possible ranges of temperature fluctuations.
- Create a data set with environmental conditions that we may use in the experiment and calculate RD knowing the direction of the environmental change.

- fluctuating temperature x 3 fixed nutrients = 9 treatments

## Magnitude of T change - 1
- first fluctuation ranges are going to be 18-22, 22-26, and 24 - 28. Temperature stays at the lower end of the range (i.e. 18C) for 3 days, it increases over 24h and stays at the higher end for 3 days.


```{r env_sp2_t1, fig.cap='Time series of the environmental conditions for temperature (a) and nutrients (b). These environmental conditions represent the "treatments" and will be crossed in a full factorial design resulting in 9 unique treatments', fig.align="center", fig.height=8, fig.width=15}
### Create a data set with environmental conditions that we may use in the experiment to see if RD calculated from known direction of environmental change 
### is different from potential RD, or if we get a good estimate.
### 3 fluctuating temperature x 3 fixed nutrients = 9 treatments

### T1 = fluctuating between 18 and 22
# Create a sequence of time points (one measurement per day)
# Set the duration of the time series
total_days <- 60

# Initialize a data frame to store the time series
env_data_1 <- data.frame(
  time = rep(1:total_days, 3),  # Time points for 60 days repeated 3 times for each nutrient level
  temperature = rep(NA, total_days * 3),  # Initialize temperature column
  nutrients = rep(NA, total_days * 3)  # Initialize nutrients column
)

# Set temperature values based on the description
temperature_pattern <- c(rep(18, 3), rep(21, 3))
temperature_pattern <- rep(temperature_pattern, length.out = total_days)

# Assign the temperature pattern to the temperature column for all nutrient levels

env_data_1$temperature <- temperature_pattern

# Set nutrients levels for each time point
env_data_1$nutrients <- rep(c(0.01, 0.75, 3), each = total_days)
# Create a unique identifier for each combination of temperature and nutrient levels
env_data_1$treatment <- paste0("Tmp_18_21", "_Nut", env_data_1$nutrients)



# Plot temperature and nutrient level over time
# Plot temperature over time
# p1 <- ggplot(env_data_1, aes(x = time, y = temperature)) +
#   geom_line(color = "red") +
#   labs(x = "Time (days)", y = "Temperature (Â°C)") +
#   ggtitle("Temperature Over Time") +
#   facet_grid(~nutrients) +
#   ylim(18, 28) +
#   theme_bw()
# 
# # Plot nutrient level over time
# p2 <- ggplot(env_data_1, aes(x = time, y = nutrients)) +
#   geom_line(color = "blue") +
#   labs(x = "Time (days)", y = "Nutrient Level") +
#   ggtitle("Nutrient Level Over Time") +
#   facet_grid(~nutrients) +
#   ylim(1, 5) +
#   theme_bw()


# env_data_1_plot <- p1 / p2



### T2 = fluctuating between 22 and 26 every 72h by 4 degree Celsius
total_days <- 60

# Initialize a data frame to store the time series
env_data_2 <- data.frame(
  time = rep(1:total_days, 3),  # Time points for 60 days repeated 3 times for each nutrient level
  temperature = rep(NA, total_days * 3),  # Initialize temperature column
  nutrients = rep(NA, total_days * 3)  # Initialize nutrients column
)

# Set temperature values based on the description
temperature_pattern <- c(rep(22, 3), rep(25, 3))
temperature_pattern <- rep(temperature_pattern, length.out = total_days)

# Assign the temperature pattern to the temperature column for all nutrient levels

env_data_2$temperature <- temperature_pattern

# Set nutrients levels for each time point
env_data_2$nutrients <- rep(c(0.01, 0.75, 3), each = total_days)
env_data_2$treatment <- paste0("Tmp_22_25", "_Nut", env_data_2$nutrients)

# Plot temperature and nutrient level over time
# Plot temperature over time
# p1 <- ggplot(env_data_2, aes(x = time, y = temperature)) +
#   geom_line(color = "red") +
#   labs(x = "Time (days)", y = "Temperature (Â°C)") +
#   ggtitle("Temperature Over Time") +
#   facet_grid(~nutrients) +
#   ylim(18, 28) +
#   theme_bw()
# 
# # Plot nutrient level over time
# p2 <- ggplot(env_data_2, aes(x = time, y = nutrients)) +
#   geom_line(color = "blue") +
#   labs(x = "Time (days)", y = "Nutrient Level") +
#   ggtitle("Nutrient Level Over Time") +
#   facet_grid(~nutrients) +
#   ylim(1, 5) +
#   theme_bw()
# 
# 
# env_data_2_plot <- p1 / p2



### T3 = fluctuating between 24 and 28 
total_days <- 60

# Initialize a data frame to store the time series
env_data_3 <- data.frame(
  time = rep(1:total_days, 3),  # Time points for 60 days repeated 3 times for each nutrient level
  temperature = rep(NA, total_days * 3),  # Initialize temperature column
  nutrients = rep(NA, total_days * 3)  # Initialize nutrients column
)

# Set temperature values based on the description
temperature_pattern <- c(rep(25, 3), rep(28, 3))
temperature_pattern <- rep(temperature_pattern, length.out = total_days)

# Assign the temperature pattern to the temperature column for all nutrient levels

env_data_3$temperature <- temperature_pattern

# Set nutrients levels for each time point
env_data_3$nutrients <- rep(c(0.01, 0.75, 3), each = total_days)
env_data_3$treatment <- paste0("Tmp_25_28", "_Nut", env_data_3$nutrients)
# Plot temperature and nutrient level over time
# Plot temperature over time
# p1 <- ggplot(env_data_3, aes(x = time, y = temperature)) +
#   geom_line(color = "red") +
#   labs(x = "Time (days)", y = "Temperature (Â°C)") +
#   ggtitle("Temperature Over Time") +
#   facet_grid(~nutrients) +
#   ylim(18, 28) +
#   theme_bw()
# 
# # Plot nutrient level over time
# p2 <- ggplot(env_data_3, aes(x = time, y = nutrients)) +
#   geom_line(color = "blue") +
#   labs(x = "Time (days)", y = "Nutrient Level") +
#   ggtitle("Nutrient Level Over Time") +
#   facet_grid(~nutrients) +
#   ylim(1, 5) +
#   theme_bw()
# 
# 
# env_data_3_plot <- p1 / p2

### Try to merge the 3 env_data
env_data_1 <- env_data_1 %>% mutate(temperature_treatment = "18_21")
env_data_2 <- env_data_2 %>% mutate(temperature_treatment = "22_25")
env_data_3 <- env_data_3 %>% mutate(temperature_treatment = "25_28")
env_data <- rbind(env_data_1, env_data_2, env_data_3)

p1 <- ggplot(env_data, aes(x = time, y = temperature)) +
  geom_line(color = "red") +
  labs(x = "Time (days)", y = "Temperature (Â°C)") +
  ggtitle("Temperature Over Time") +
  facet_grid(~temperature_treatment) +
  ylim(18, 28) +
  theme_bw()+
   theme(# Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20))


p2 <- ggplot(env_data, aes(x = time, y = nutrients)) +
  geom_line(color = "blue") +
  labs(x = "Time (days)", y = "Nutrient Level") +
  ggtitle("Nutrient Level Over Time") +
  facet_grid(~nutrients) +
  ylim(0, 4) +
  theme_bw()+
   theme(# Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20))

p1 / p2


```


### Response diversity 2 species communities

Same steps as before:

- Create all possible communities with 2 species
```{r}
all_species <- c("Colpidium", "Dexiostoma", "Loxocephalus", "Paramecium", "Spirostomum")
# Create all possible combinations of 2 species names
all_combinations_2species <- combn(c("Colpidium", "Dexiostoma", "Loxocephalus", "Paramecium", "Spirostomum"), 2, simplify = TRUE)
```

- Actual RD calculation
(since temperature and nutrients are the same for 3 days in a row, the magnitude of the unit vector is zero [no direction of environmental change], so we get NAs for divergence. We replace these with zeros)
```{r}

# Use lapply to iterate through each pair
# get_RD_ours <- function(species_names, nested_gams, E1_var, E2_var)  
# specify variables names for the "get_RD_ours" function
E1_var <- "temperature"
E2_var <- "nutrients"
env_data <- env_data
result_list_2species_RD <- lapply(1:ncol(all_combinations_2species), function(i) {
  E1_var <- "temperature"
  E2_var <- "nutrients"
  species_names <- all_combinations_2species[, i]
  result <- get_RD_ours(species_names, nested_gams, E1_var, E2_var)
  return(result)
})


# Combine all data frames into a single data frame
RD_2species <- do.call(rbind, result_list_2species_RD)

# Add a new column "composition" with the initial letters of species1 and species2
RD_2species <- RD_2species %>%
  mutate(composition = str_split(species, "_") %>% 
           map_chr(~ paste0(substr(.x, 1, 1), collapse = ""))) %>%   mutate(richness = 2)



RD_2species_mag_1 <- RD_2species %>% rename(temperature = E1_ref,
                         nutrients = E2_ref) 

#RD_2species$divergence <- replace(RD_2species$divergence, is.nan(RD_2species$divergence), 0)
```

Results
```{r results='asis', message=FALSE, warning=FALSE}
## Display the parameter table
head(RD_2species_mag_1,
              filter="top")

unique(RD_2species_mag_1$composition)
```

```{r RD_2sp_t1, fig.cap='Response diversity calcualted as dissimilarity (a) and diversity (b) of communities composed of all possible combinations of 2 species', fig.align="center", fig.height=8, fig.width=25}


# Plot boxplots for divergence by composition using different colors from the Viridis palette
dissimilarity_2sp_plot <- ggplot(RD_2species_mag_1, aes(x = composition, y = dissimilarity, fill = composition)) +
  geom_boxplot(alpha = 0.7) +  # Boxplots
  geom_jitter(width = 0.2, alpha = 0.7) +  # Individual points with jitter
  labs(x = "Composition", y = "Dissimilarity") +
  #facet_grid(~combination) +
  scale_fill_viridis_d() +  # Use the Viridis palette
  theme_bw() + labs(tag = "(a)")+
   theme(
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20))
# Plot boxplots for divergence by composition using different colors from the Viridis palette
divergence_2sp_plot <-  ggplot(RD_2species_mag_1, aes(x = composition, y = divergence, fill = composition)) +
  geom_boxplot(alpha = 0.7) +  # Boxplots
  geom_jitter(width = 0.2, alpha = 0.7) +  # Individual points with jitter
  labs(x = "Composition", y = "Divergence") +
  #facet_grid(~combination) +
  scale_fill_viridis_d() +  # Use the Viridis palette
  theme_bw() + labs(tag = "(b)")+
   theme(
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20))

RD_2sp  <- dissimilarity_2sp_plot + divergence_2sp_plot

RD_2sp

### Calculate the composition with the highest response divergence across the 3 combinations
summary_RD_2spp <- RD_2species_mag_1 %>% dplyr::group_by(composition) %>% 
  mutate(mean_div = mean(divergence)) %>% 
  select(composition, mean_div, richness) %>% 
  distinct(composition, .keep_all = TRUE)


RD_2species_mag_1 <- RD_2species_mag_1 %>% 
  filter(dissimilarity == unique(dissimilarity))
  

```

### Response diversity 3 species communities 

- Create all possible communities with 2 species
```{r}
# Create all possible combinations of 2 species names
combinations_3species <- combn(c("Colpidium", "Dexiostoma", "Loxocephalus", "Paramecium", "Spirostomum"), 3, simplify = TRUE)
```


Now, we calculate RD for all possible communities of 3 species knowing the direction of the environmental change (we created before).
```{r}
### Now same but with 3 species
#T1
E1_var <- "temperature"
E2_var <- "nutrients"
env_data <- env_data
result_list_3species_RD <- lapply(1:ncol(combinations_3species), function(i) {
  E1_var <- "temperature"
  E2_var <- "nutrients"
  species_names <- combinations_3species[, i]
  result <- get_RD_ours(species_names, nested_gams, E1_var, E2_var)
  return(result)
})


# Combine all data frames into a single data frame
RD_3species <- do.call(rbind, result_list_3species_RD)

# Add a new column "composition" with the initial letters of species1 and species2
RD_3species <- RD_3species %>%
  mutate(composition = str_split(species, "_") %>% 
           map_chr(~ paste0(substr(.x, 1, 1), collapse = ""))) %>%   mutate(richness = 3)




RD_3species_mag_1 <- RD_3species %>% rename(temperature = E1_ref,
                                          nutrients = E2_ref) 
```

```{r results='asis', message=FALSE, warning=FALSE}
## Display the parameter table
head(RD_3species_mag_1,
              filter="top")


```

```{r RD_3sp_t1, fig.cap='Response diversity calcualted as dissimilarity (a) and diversity (b) of communities composed of all possible combinations of 3 species', fig.align="center", fig.height=8, fig.width=25}
# Plot boxplots for divergence by composition using different colors from the Viridis palette
dissimilarity_3sp_plot <- ggplot(RD_3species_mag_1, aes(x = composition, y = dissimilarity, fill = composition)) +
  geom_boxplot(alpha = 0.7) +  # Boxplots
  geom_jitter(width = 0.2, alpha = 0.7) +  # Individual points with jitter
  labs(x = "Composition", y = "Dissimilarity") +
   scale_fill_viridis_d() +  # Use the Viridis palette
  theme_bw()+
   theme(
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20))


divergence_3sp_plot <-  ggplot(RD_3species_mag_1, aes(x = composition, y = divergence, fill = composition)) +
  geom_boxplot(alpha = 0.7) +  # Boxplots
  geom_jitter(width = 0.2, alpha = 0.7) +  # Individual points with jitter
  labs(x = "Composition", y = "Divergence") +
  scale_fill_viridis_d() +  # Use the Viridis palette
  theme_bw()+
   theme(
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20))

RD_3sp  <- dissimilarity_3sp_plot + divergence_3sp_plot

### Calculate the composition with the highest response divergence across the 3 combinations
summary_RD_3spp <- RD_3species %>% dplyr::group_by(composition) %>% 
  mutate(mean_div = mean(divergence)) %>% 
  select(composition, mean_div, richness) %>% 
  distinct(composition, .keep_all = TRUE)


RD_3sp
```

### Response diversity 4 species communities

Now, we calculate RD for all possible communities of 4 species knowing the direction of the environmental change (we created before).



```{r}
# Create all possible combinations of 2 species names
combinations_4species <- combn(c("Colpidium", "Dexiostoma", "Loxocephalus", "Paramecium", "Spirostomum"), 4, simplify = TRUE)
```

```{r}
### Now same but with 4 species
#T1
E1_var <- "temperature"
E2_var <- "nutrients"
env_data <- env_data
result_list_4species_RD <- lapply(1:ncol(combinations_4species), function(i) {
  E1_var <- "temperature"
  E2_var <- "nutrients"
  species_names <- combinations_4species[, i]
  result <- get_RD_ours(species_names, nested_gams, E1_var, E2_var)
  return(result)
})


# Combine all data frames into a single data frame
RD_4species <- do.call(rbind, result_list_4species_RD)

# Add a new column "composition" with the initial letters of species1 and species2
RD_4species <- RD_4species %>%
  mutate(composition = str_split(species, "_") %>% 
           map_chr(~ paste0(substr(.x, 1, 1), collapse = ""))) %>%   mutate(richness = 4)




RD_4species_mag_1 <- RD_4species %>% rename(temperature = E1_ref,
                                          nutrients = E2_ref) 
```

```{r results='asis', message=FALSE, warning=FALSE}
## Display the parameter table
head(RD_4species_mag_1,
              filter="top")


```

```{r RD_4sp_t1, fig.cap='Response diversity calcualted as dissimilarity (a) and diversity (b) of communities composed of all possible combinations of 4 species', fig.align="center", fig.height=8, fig.width=25}
# Plot boxplots for divergence by composition using different colors from the Viridis palette
dissimilarity_4sp_plot <- ggplot(RD_4species_mag_1, aes(x = composition, y = dissimilarity, fill = composition)) +
  geom_boxplot(alpha = 0.7) +  # Boxplots
  geom_jitter(width = 0.2, alpha = 0.7) +  # Individual points with jitter
  labs(x = "Composition", y = "Dissimilarity") +
   scale_fill_viridis_d() +  # Use the Viridis palette
  theme_bw() +
   theme(
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20))


divergence_4sp_plot <-  ggplot(RD_4species_mag_1, aes(x = composition, y = divergence, fill = composition)) +
  geom_boxplot(alpha = 0.7) +  # Boxplots
  geom_jitter(width = 0.2, alpha = 0.7) +  # Individual points with jitter
  labs(x = "Composition", y = "Divergence") +
  scale_fill_viridis_d() +  # Use the Viridis palette
  theme_bw() +
   theme(
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20))

RD_4sp  <- dissimilarity_4sp_plot + divergence_4sp_plot

### Calculate the composition with the highest response divergence across the 4 combinations
summary_RD_4spp <- RD_4species %>% dplyr::group_by(composition) %>% 
  mutate(mean_div = mean(divergence)) %>% 
  select(composition, mean_div, richness) %>% 
  distinct(composition, .keep_all = TRUE)


RD_4sp
```

```{r summary_RD_t1, fig.cap='Summary of Response divergence measured for all possible communities of 2, 3, and 4 species with known direction of environmental change', fig.align="center", fig.height=8, fig.width=10}
summary_RD_scen1 <- rbind(summary_RD_2spp, summary_RD_3spp, summary_RD_4spp)

summary_RD_scen1 %>% 
  ggplot(aes(x = richness, y = mean_div)) +
  geom_point(size = 1.5) +
  geom_text(aes(label = composition), vjust = -0.5, size = 4) +
  theme_bw() + scale_x_continuous(breaks = c(2, 3, 4)) +
  labs(y = "Mean Divergence") +
   theme(
    # Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20))  # Adjust the size as needed
  

```

```{r}
mag_1 <- rbind(RD_2species_mag_1, RD_3species_mag_1, RD_4species_mag_1)

unique_values <- mag_1 %>%
  distinct(treatment, composition, dissimilarity, divergence, .keep_all = TRUE)

unique_values %>% filter(richness == 2) %>% drop_na() %>% 
  ggplot(aes(x = treatment, y = divergence )) +
  geom_point(size = 1.5) +
  geom_text(aes(label = composition), vjust = -0.5, size = 4) +
  theme_bw() + 
  labs(y = "Divergence") 

```


## Select communities

```{r}
library(ggrepel)

#write.csv(mag_1,"final_scenario_2.csv")

mag_1<- read_csv("final_scenario_2.csv")
#View(mag_1)

selection<-mag_1[!is.na(mag_1$divergence),]
selection<-distinct(selection,treatment,richness,composition,divergence,.keep_all = T)

unique(selection$treatment)






sel_means <- selection %>%
  group_by(treatment, richness, composition) %>%
  summarize(mean_divergence = mean(divergence))


all_comm_plot<-ggplot(sel_means,aes(x=richness,y=mean_divergence,label=composition))+
  geom_point()+
  #geom_smooth(method="lm")+
  theme_bw()+
  facet_wrap(~treatment)+
  geom_text_repel(size = 2,max.overlaps = 100)+
  labs(title ="all communities")
  




# Group by composition and treatment
grouped_dd <- sel_means %>%
  group_by(richness, treatment)

# Find the row with the maximum mean_divergence
max_row <- grouped_dd %>%
  filter(mean_divergence == max(mean_divergence))

# Find the row with the minimum mean_divergence
min_row <- grouped_dd %>%
  filter(mean_divergence == min(mean_divergence))



# Find the row with the mean_divergence closest to the mean value for each combination

closest_to_mean_row <- grouped_dd %>%
  filter(abs(mean_divergence - mean(mean_divergence)) == min(abs(mean_divergence - mean(mean_divergence))))


# Find median value
median_row <- grouped_dd %>%
  filter(abs(mean_divergence - median(mean_divergence)) == min(abs(mean_divergence - median(mean_divergence))))



# Combine the results into a single dataframe
selection_final_mean <- bind_rows(max_row, min_row, closest_to_mean_row)

selection_final_median <- bind_rows(max_row, min_row, median_row)

#random sample if double entries
selection_mean<-data.frame(treatment=character(),richness=numeric(),composition=character(),mean_divergence=numeric())





set.seed(27032024)
selection_mean <- selection_final_mean %>%
  group_by(treatment, richness, mean_divergence) %>%
  slice_sample(n = 1) %>%
  ungroup()


selection_mean <- selection_mean %>%
  arrange(treatment, richness, mean_divergence)


rownames(selection_mean) <- NULL





mean_plot<-ggplot(selection_mean,aes(x=richness,y=mean_divergence,label=composition))+
  geom_point()+
  #geom_smooth(method="lm")+
  facet_wrap(~treatment)+
  geom_text_repel(size = 2,max.overlaps = 100)+
  labs(title = "criteria: mean") 


median_plot<-ggplot(selection_final_median,aes(x=richness,y=mean_divergence,label=composition))+
  geom_point()+
  #geom_smooth(method="lm")+
  theme_bw()+
  facet_wrap(~treatment)+
  geom_text_repel(size = 2,max.overlaps = 100)+
  labs(title = "criteria: median") 


mean_plot+median_plot+all_comm_plot

all_comm_plot
```


##Check divergence

```{r}




new_data <- expand_grid(temperature = seq(18, 28, by= 0.02),
                        nutrients = rep(2))





new_nested_gams<-nested_gams%>%filter(species!="Tetrahymena")


get_check_plot<-function(nutrient_level){
  
  new_data <- expand_grid(temperature = seq(18, 28, by= 0.02),
                        nutrients = rep(nutrient_level))
  num_rows <- nrow(new_data)

pred_slice <- data.frame(matrix(nrow = num_rows, ncol = 0))

for (j in 1:length(new_nested_gams$species)) {
  predictions <- unlist(map(nested_gams$gams[j], ~ predict(.x, newdata = new_data)))
  pred_slice <- bind_rows(pred_slice, data.frame(prediction = predictions, species = new_nested_gams$species[j]))
}

pred_slice <- na.omit(pred_slice)

pred_slice<-cbind(pred_slice,new_data)



plot<-ggplot(data=pred_slice,aes(x=temperature,y=prediction,colour=species))+
  annotate("rect", xmin = 25, xmax = 28, ymin = -0.5, ymax = 1,
           alpha = .4,fill = "grey")+
  geom_line()+
  scale_color_brewer(palette = "Dark2",guide = "none")+
  ylab("growth rate")+
  scale_x_continuous(breaks = seq(18, 28, by = 1))+
  theme(axis.title.x=element_blank())+
  ylim(-0.5,1)
  #geom_vline(xintercept = c(18, 21), linetype = "dashed", color = "black")+
  #geom_vline(xintercept = c(22, 24.95), linetype = "dotted", color = "black")+
#geom_vline(xintercept = c(25.05, 28), color = "black")+
  #labs(title = paste("nutrient level",nutrient_level))
  
  
  return(plot)
}



n_1<-get_check_plot(0.01)
n_2<-get_check_plot(0.75)
n_5<-get_check_plot(3)


# Check divergence levels


n_1+mean_plot


n_5_div<-ggplot(selection_final_mean%>%filter(treatment==	
"Tmp_25_28_Nut5"),aes(x=richness,y=mean_divergence,label=composition))+
  geom_point()+
  theme_bw()+
  facet_wrap(~treatment)+
  geom_text_repel(size = 2,max.overlaps = 20)

n_5+all_comm_plot
n_2+all_comm_plot

```


#get the derivative


```{r}

get_deriv<-function(nutrient_level,sp){
  env_range<-data.frame(temperature=seq(18,28,by=0.01))
  env_range<-mutate(env_range,nutrients=rep(nutrient_level))
  new_df<-data.frame()
  partial_df<-data.frame()
  for(i in 1:5){
    new_df<-data.frame(pd=partial_derivatives(new_nested_gams$gams[[i]],data=env_range,type = "central",focal = "temperature")$partial_deriv)
  new_df<-mutate(new_df,species=rep(new_nested_gams$species[i]),temperature=env_range$temperature)
  partial_df<-rbind(partial_df,new_df)
 }

  partial_df<-filter(partial_df,species%in%sp)
  
partial_Nut2<-ggplot(data=partial_df,aes(x=temperature,y=pd,color=species))+
  annotate("rect", xmin = 25, xmax = 28, ymin = -0.15, ymax = 0.5,
           alpha = .4,fill = "grey")+
  geom_hline(yintercept = 0, linetype = "dashed", color =    "black")+
  geom_line()+
  #theme_bw()+
  scale_color_brewer(palette = "Dark2",guide="none")+
  scale_x_continuous(breaks = seq(18, 28, by = 1))+
  ylim(-0.15,0.5)+
  ylab("directional derivative")+
  xlab("temperature [Â°C]")
  #geom_vline(xintercept = c(18, 21), linetype = "dashed", color =     "black")+
  #geom_vline(xintercept = c(22, 25), linetype = "dotted", color =    "black")+
  #geom_vline(xintercept = c(25.05, 28), color = "black")+
  #labs(title = paste("nutrient concentration",nutrient_level,"mg/L"))+

  


}

dn_1<-get_deriv(0.01,sp=c("Colpidium","Spirostomum","Paramecium","Dexiostoma","Loxocephalus"))
dn_2<-get_deriv(0.75,sp=c("Colpidium","Spirostomum","Paramecium","Dexiostoma","Loxocephalus"))
dn_5<-get_deriv(3,sp=c("Colpidium","Spirostomum","Paramecium","Dexiostoma","Loxocephalus"))

dn_5+all_comm_plot
dn_5+mean_plot
dn_1+mean_plot
dn_2+mean_plot


```

#alternative divergence
```{r}

resp_div_alt<- function(x, sign_sens = TRUE) {
  
  flag <- TRUE # flag to catch if all values are the same
  
  ## set diversity to zero if all values are the same
  if(length(unique(x)) == 1) {
    div = 0
    flag <- FALSE
  }
  
  ## keep going only if all values are not the same
  if(flag) {
    
    ## stat == range
    if(!sign_sens) {
        
        d <- dist(x, diag = T) # euclidean distance matrix
        Z <- exp(as.matrix(-d)) # similarity matrix
        nspecies <- length(x)
        p=matrix(1/nspecies,nspecies) # relative abundance matrix. Needs to be changed if evenness is of interest
        lenq = 1 # initialises hill number. Need to fix if we want any evenness indices
        qq <- seq(length=lenq, from=0, by=.11)
        
        # Initialise the Zp matrix to zero
        Zp=matrix(0,nspecies,1)
        
        # Compute Zp
        for (i in 1:nspecies){
          for (j in 1:nspecies){
            Zp[i,1]<-Zp[i,1]+Z[i,j]*p[j,1]
          }
        }
        
        # Initialise the Diversity matrix to zero
        Dqz = matrix(0, lenq ,1)
        
        for (iq in 1:lenq)  {
          q<-qq[iq];
          for (zpi in 1:length(Zp[,1])){
            if (Zp[zpi,1]>0)(
              Dqz[iq,1]<-Dqz[iq,1]+ p[zpi,1]*(Zp[zpi,1])^(q-1))
          }
          
          Dqz[iq,1] <- Dqz[iq,1]^(1/(1-q));
        }
        div <- Dqz[iq,1]
    }
        
      }
      
      if(sign_sens) {
        
        x_pos<-sum(x[x>=0])
        x_neg<-sum(x[x<=0])
        
        
        div1 <- x_pos - x_neg
        div2 <- abs(abs(x_pos) - abs(x_neg))
        div <- (div1 - div2) / div1
    }
  
  names(div) <- paste(sign_sens)
  
  div
  
}





get_RD_ours_alt <- function(species_names, nested_gams, E1_var, E2_var) {
  species_data <- nested_gams %>% filter(species %in% species_names)


m_list <- species_data$gams
my_spp_names <- paste0("s_", species_data$species)

# Extract partial derivatives
pd_list <- modify_depth(m_list, 1, ~ get_partials_mod(., env_data, E1_var, E2_var))
# from list to tibble
(pd_spp <- tibble(
  E1_ref = map(pd_list, E1_var),
  E2_ref = map(pd_list, E2_var),
  pd_E1 = map(pd_list, paste0("pd_", E1_var)),
  pd_E2 = map(pd_list, paste0("pd_", E2_var)) 
)%>% 
    dplyr::mutate(sp = my_spp_names) %>%
    unnest(c(E1_ref, E2_ref, pd_E1, pd_E2)))

# add time
(pd_spp <-cbind(pd_spp, env_data$time, env_data$treatment) %>% 
    dplyr::rename(time = "env_data$time",
                  treatment = "env_data$treatment")) 
  

# calculation next value for directional derivatives, and get directional derivatives
(pd_spp <- pd_spp %>% transform( nxt_value_E1 = c(E1_ref[-1], NA)) %>%
    transform(nxt_value_E2 = c(E2_ref[-1], NA)) %>%
    dplyr::mutate(del_E1 = nxt_value_E1 - E1_ref,
                  del_E2 = nxt_value_E2 - E2_ref,
                  unit_vec_mag =  sqrt(del_E1^2 + del_E2^2),
                  uv_E1 = del_E1 / unit_vec_mag,
                  uv_E2 = del_E2 / unit_vec_mag,
                  dir_deriv = pd_E1 * uv_E1 +  pd_E2 * uv_E2) %>% 
    filter(time != max(time)))


red_spp <- pd_spp %>%  dplyr::select(sp, time, E1_ref, E2_ref, dir_deriv, treatment)
# from long to wide
rdiv_1 <- red_spp %>%
  spread( sp, dir_deriv)

rdiv_1[is.na(rdiv_1)] <- 0


# actual calculation for only the same species used above
rdiv_1$dissimilarity<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div_alt, sign_sens = F)
rdiv_1$divergence<-apply(dplyr:: select(rdiv_1, starts_with("s")), 1, resp_div_alt, sign_sens = T)                  
# Add species names to the result
rdiv_1$species <- paste(species_names, collapse = "_")
rdiv_1 <- rdiv_1 %>% select(time, treatment, E1_ref, E2_ref, dissimilarity, divergence, species)
# community 1 
# Return the result
return(rdiv_1)
}



```




### Response diversity 2 species communities

Same steps as before:

- Create all possible communities with 2 species
```{r}
all_species <- c("Colpidium", "Dexiostoma", "Loxocephalus", "Paramecium", "Spirostomum")
# Create all possible combinations of 2 species names
all_combinations_2species <- combn(c("Colpidium", "Dexiostoma", "Loxocephalus", "Paramecium", "Spirostomum"), 2, simplify = TRUE)
```

- Actual RD calculation
(since temperature and nutrients are the same for 3 days in a row, the magnitude of the unit vector is zero [no direction of environmental change], so we get NAs for divergence. We replace these with zeros)
```{r}

# Use lapply to iterate through each pair
# get_RD_ours <- function(species_names, nested_gams, E1_var, E2_var)  
# specify variables names for the "get_RD_ours" function
E1_var <- "temperature"
E2_var <- "nutrients"
env_data <- env_data
result_list_2species_RD <- lapply(1:ncol(all_combinations_2species), function(i) {
  E1_var <- "temperature"
  E2_var <- "nutrients"
  species_names <- all_combinations_2species[, i]
  result <- get_RD_ours_alt(species_names, nested_gams, E1_var, E2_var)
  return(result)
})


# Combine all data frames into a single data frame
RD_2species <- do.call(rbind, result_list_2species_RD)

# Add a new column "composition" with the initial letters of species1 and species2
RD_2species <- RD_2species %>%
  mutate(composition = str_split(species, "_") %>% 
           map_chr(~ paste0(substr(.x, 1, 1), collapse = ""))) %>%   mutate(richness = 2)



RD_2species_mag_1 <- RD_2species %>% rename(temperature = E1_ref,
                         nutrients = E2_ref) 

#RD_2species$divergence <- replace(RD_2species$divergence, is.nan(RD_2species$divergence), 0)
```

Results
```{r results='asis', message=FALSE, warning=FALSE}
## Display the parameter table
head(RD_2species_mag_1,
              filter="top")

unique(RD_2species_mag_1$composition)
```




### Response diversity 3 species communities 

- Create all possible communities with 2 species
```{r}
# Create all possible combinations of 2 species names
combinations_3species <- combn(c("Colpidium", "Dexiostoma", "Loxocephalus", "Paramecium", "Spirostomum"), 3, simplify = TRUE)
```


Now, we calculate RD for all possible communities of 3 species knowing the direction of the environmental change (we created before).
```{r}
### Now same but with 3 species
#T1
E1_var <- "temperature"
E2_var <- "nutrients"
env_data <- env_data
result_list_3species_RD <- lapply(1:ncol(combinations_3species), function(i) {
  E1_var <- "temperature"
  E2_var <- "nutrients"
  species_names <- combinations_3species[, i]
  result <- get_RD_ours_alt(species_names, nested_gams, E1_var, E2_var)
  return(result)
})


# Combine all data frames into a single data frame
RD_3species <- do.call(rbind, result_list_3species_RD)

# Add a new column "composition" with the initial letters of species1 and species2
RD_3species <- RD_3species %>%
  mutate(composition = str_split(species, "_") %>% 
           map_chr(~ paste0(substr(.x, 1, 1), collapse = ""))) %>%   mutate(richness = 3)




RD_3species_mag_1 <- RD_3species %>% rename(temperature = E1_ref,
                                          nutrients = E2_ref) 
```

```{r results='asis', message=FALSE, warning=FALSE}
## Display the parameter table
head(RD_3species_mag_1,
              filter="top")


```



### Response diversity 4 species communities

Now, we calculate RD for all possible communities of 4 species knowing the direction of the environmental change (we created before).



```{r}
# Create all possible combinations of 2 species names
combinations_4species <- combn(c("Colpidium", "Dexiostoma", "Loxocephalus", "Paramecium", "Spirostomum"), 4, simplify = TRUE)
```

```{r}
### Now same but with 4 species
#T1
E1_var <- "temperature"
E2_var <- "nutrients"
env_data <- env_data
result_list_4species_RD <- lapply(1:ncol(combinations_4species), function(i) {
  E1_var <- "temperature"
  E2_var <- "nutrients"
  species_names <- combinations_4species[, i]
  result <- get_RD_ours_alt(species_names, nested_gams, E1_var, E2_var)
  return(result)
})


# Combine all data frames into a single data frame
RD_4species <- do.call(rbind, result_list_4species_RD)

# Add a new column "composition" with the initial letters of species1 and species2
RD_4species <- RD_4species %>%
  mutate(composition = str_split(species, "_") %>% 
           map_chr(~ paste0(substr(.x, 1, 1), collapse = ""))) %>%   mutate(richness = 4)




RD_4species_mag_1 <- RD_4species %>% rename(temperature = E1_ref,
                                          nutrients = E2_ref) 
```

```{r results='asis', message=FALSE, warning=FALSE}
## Display the parameter table
head(RD_4species_mag_1,
              filter="top")




```



##select communities

```{r}

mag_2 <- rbind(RD_2species_mag_1, RD_3species_mag_1, RD_4species_mag_1)

#write.csv(mag_2,"final_scenario_alt_divergence.csv")


selection_2<-mag_2[!is.na(mag_2$divergence),]
selection_2<-distinct(selection_2,treatment,richness,composition,divergence,.keep_all = T)








sel_means_2 <- selection_2 %>%
  group_by(treatment, richness, composition) %>%
  summarize(mean_divergence = mean(divergence))


all_comm_plot_2<-ggplot(sel_means_2,aes(x=richness,y=mean_divergence,label=composition))+
  geom_point()+
  #geom_smooth(method="lm")+
  theme_bw()+
  facet_wrap(~treatment)+
  geom_text_repel(size = 2,max.overlaps = 100)+
  labs(title ="all communities alt")

all_comm_plot+all_comm_plot_2


cor(sel_means_2$mean_divergence,sel_means$mean_divergence)

cor_df<-rename(sel_means_2,alt_divergence="mean_divergence")
cor_df<-cbind(sel_means,alt_divergence=cor_df$alt_divergence)
cor_df<-filter(cor_df,richness>2)

ggplot(cor_df,aes(x=mean_divergence,y=alt_divergence))+
  geom_point()+
  theme_bw()
cor(cor_df$mean_divergence,cor_df$alt_divergence)


# Group by composition and treatment
grouped_dd <- sel_means_2 %>%
  group_by(richness, treatment)

# Find the row with the maximum mean_divergence
max_row <- grouped_dd %>%
  filter(mean_divergence == max(mean_divergence))

# Find the row with the minimum mean_divergence
min_row <- grouped_dd %>%
  filter(mean_divergence == min(mean_divergence))



# Find the row with the mean_divergence closest to the mean value for each combination

closest_to_mean_row <- grouped_dd %>%
  filter(abs(mean_divergence - mean(mean_divergence)) == min(abs(mean_divergence - mean(mean_divergence))))

# Find median value
median_row <- grouped_dd %>%
  filter(abs(mean_divergence - median(mean_divergence)) == min(abs(mean_divergence - median(mean_divergence))))



# Combine the results into a single dataframe
selection_final_mean_2 <- bind_rows(max_row, min_row, closest_to_mean_row)

selection_final_median_2 <- bind_rows(max_row, min_row, median_row)








mean_plot_alt<-ggplot(selection_final_mean_2,aes(x=richness,y=mean_divergence,label=composition))+
  geom_point()+
  #geom_smooth(method="lm")+
  theme_bw()+
  facet_wrap(~treatment)+
  geom_text_repel(size = 2,max.overlaps = 100)+
  labs(title = "criteria: mean (alt)") 


mean_plot+mean_plot_alt
```




## average performance
```{r}

get_performance<-function(nutrient_level,temp){
  
  new_data <- expand_grid(temperature = temp,
                        nutrients = nutrient_level)
  num_rows <- nrow(new_data)

pred_slice <- data.frame(matrix(nrow = num_rows, ncol = 0))

for (j in 1:length(new_nested_gams$species)) {
  predictions <- unlist(map(nested_gams$gams[j], ~ predict(.x, newdata = new_data)))
  pred_slice <- bind_rows(pred_slice, data.frame(prediction = predictions, species = new_nested_gams$species[j]))
}

pred_slice <- na.omit(pred_slice)

pred_slice<-cbind(pred_slice,new_data)

  return(pred_slice)
}


pred_r<-get_performance(c(1,2,5),c(18,21,22,25,28))

pred_r_comb<-expand.grid(temperature=c(18,21,22,25,28),
                         nutrient=c(1,2,5),
                         composition=unique(selection$composition))

av_perf<-c()
for(i in 1:length(pred_r_comb$composition)){
  comp<-as.character(pred_r_comb$composition)[i]
  len<-nchar(comp)
  cha<-c()
  for (b in 1:len){
    cha<-cha%>%append(substr(comp, b, b))
  }
  
  perfs<-filter(pred_r,substr(species, 1, 1)%in%cha,
         temperature==pred_r_comb$temperature[i],
         nutrients==pred_r_comb$nutrient[i])
  mean_perf<-mean(perfs$prediction)
  
  av_perf<-av_perf%>%append(mean_perf)
}
av_perf


pred_r_comb<-cbind(pred_r_comb,av_perf)

View(pred_r_comb)

selection_perf<-selection

av_pref_2<-c()
for(i in 1:length(selection_perf$treatment)){
  
  s<-filter(pred_r_comb,nutrient==selection_perf$nutrients[i],
         temperature==selection_perf$temperature[i],
         composition==selection_perf$composition[i])
  av_pref_2<-av_pref_2%>%append(s$av_perf)
}

selection_perf<-cbind(selection_perf,av_pref_2)

selection_perf<-group_by(selection_perf,treatment,composition,richness)%>%summarise(mean_performance=mean(av_pref_2))


selection_perf<-cbind(selection_perf,mean_divergence=sel_means$mean_divergence)

ggplot(selection_perf,aes(x=mean_performance,y=mean_divergence))+
  geom_point()

cor(selection_perf$mean_performance,selection_perf$mean_divergence)
```




##look at nutrient lvl vs actual values
```{r}

N_lvl<-data.frame(lvl=c(1,2,3,4,5),conc=c(0.01,0.75,1.25,2.5,3))

ggplot(data=N_lvl,aes(x=lvl,y=conc))+
  geom_point()
```



## plot 3D surfaces

```{r}
library(reshape2)

df<-filter(rates,species=="Colpidium")




r_surface = acast(df, temperature ~ nutrients, value.var = "predicted") 

library(RColorBrewer)
####################################### 
plot <- plot_ly()%>%
  add_surface(z=~r_surface,type="surface",
                colorscale="Reds",
                opacity=1,
                contours=list(z=list(show=T,start=-1,end=1,size=0.1)))

v<-seq(-1,1,length.out=500*300)
matrix_data<-matrix(v,ncol=300)


plot<-plot%>%add_surface(type="surface",
                         x=rep(75,300),
                   z=~matrix_data,
                   colorscale=list(c(0,1),c("grey","grey")),
                   opacity=0.7,showscale=FALSE)

plot <- plot %>% layout(title=list(text="Colpidium",y=0.9,x=0.15),scene = list(camera = list(eye = list(x = 1.5, y = 1.5, z = 1.5)),
  xaxis = list(title = "Nutrients", tickmode = "array", tickvals = seq(50,300,by=50), ticktext = seq(0.5,3,by=0.5),showgrid=F),
                                    
  yaxis = list(title = "Temperature", tickmode = "array", tickvals = seq(0,500,by=50), ticktext = seq(18,28,by=1),showgrid=F),
                                    
  zaxis = list(visible=F,showline=F,showgrid=F)
  
  ))%>%colorbar(title = "growth rate",thickness=20,len=0.4,outlinecolor="white")
                                                             



###################################

brewer.pal(n = 8, name = "Dark2")
color_sp<-c("#1B9E77" ,"#D95F02" ,"#7570B3", "#E7298A" ,"#66A61E")

s_plots <- list()

for (i in seq_along(new_nested_gams$gams)) {
  species_name <- new_nested_gams$species[i]
  col<-color_sp[i]
 
  df<-filter(rates,species==species_name)
  r_surface <- acast(df, temperature ~ nutrients, value.var = "predicted") 

plot <- plot_ly()%>%
  add_surface(z=~r_surface,type="surface",
                colorscale=list(c(0,1),c("white",col)),
                opacity=1,
                showscale=FALSE,
                contours=list(z=list(show=T,start=-1,end=3,size=0.1)))

v<-seq(min(df$predicted),max(df$predicted),length.out=500*300)
matrix_data<-matrix(v,ncol=300)


plot<-plot%>%add_surface(type="surface",
                         x=rep(75,300),
                   z=~matrix_data,
                   colorscale=list(c(0,1),c("grey","grey")),
                   opacity=0.7,showscale=FALSE)

plot <- plot %>% layout(title=list(text=species_name,y=0.8,x=0.15),scene = list(camera = list(eye = list(x = 1.7, y = 1.7, z = 1.5)),
  xaxis = list(title = list(text="Nutrients [g/L]",font=list(size=13)), tickmode = "array", tickvals = seq(50,300,by=50), ticktext = seq(0.5,3,by=0.5),ticklen=0,showgrid=F,zeroline=F),
                                    
  yaxis = list(title =list(text="Temperature [Â°C]",font=list(size=13)), tickmode = "array", tickvals = seq(0,500,by=100), ticktext = seq(18,28,by=2),ticklabelposition="inside bottom",ticklen=0,showgrid=F,zeroline=F),
                                    
  zaxis = list(title=list(text="growth rate",font=list(size=13)),tickvals = c(-1,-0.5,0,0.5,1,1.5,2),visible=T,showgrid=T,zeroline=F)
  
  ))%>%colorbar(title = "growth rate",thickness=20,len=0.4,outlinecolor="white")
                                                    


  
  # Save the plot in the list
  s_plots[[species_name]] <- plot
  
}


s_dexiostoma <- s_plots[["Dexiostoma"]]
s_colpidium <- s_plots[["Colpidium"]]
s_loxocephalus <- s_plots[["Loxocephalus"]]
s_paramecium <- s_plots[["Paramecium"]]
s_spirostotum <- s_plots[["Spirostomum"]]


library(htmlwidgets)

# Save viewer settings (e.g. RStudio viewer pane)
op <- options()

# Set viewer to web browser
options(viewer = NULL)

# Use web browser to save image
s_dexiostoma %>% htmlwidgets::onRender(
  "function(el, x) {
  var gd = document.getElementById(el.id); 
  Plotly.downloadImage(gd, {format: 'png', width: 1200, height: 1600, filename: 's_dexiostoma'});
  }"
 )

# Restore viewer to old setting (e.g. RStudio)
options(viewer = op$viewer)

```


## figure1
```{r}
selection_mean<- selection_mean %>%
  mutate(
    temperature = gsub("Tmp_(\\d+_\\d+)_.*", "\\1", treatment),  
    temperature = gsub("_", "-", temperature),
    temperature = paste0(temperature, " Â°C")  
  )

selection_mean <- selection_mean %>%
  mutate(
    nutrients = gsub(".*Nut(\\d+(?:\\.\\d+)?)", "\\1", treatment), 
    nutrients = paste0(nutrients, " g/L")  
  )

selection_mean$richness<-as.factor(selection_mean$richness)

install.packages("lemon")
library(lemon)

mean_plot<-ggplot(selection_mean,aes(x=richness,y=mean_divergence,label=composition))+
  geom_point(size=3)+
  #geom_hline(yintercept = c(0.2, 0.4, 0.6, 0.8), color = "grey") +
  #geom_smooth(method="lm")+
  facet_rep_grid(nutrients~temperature,scales="free_x")+
  geom_text_repel(size = 5,max.overlaps = 100)+
  #labs(title = "criteria: mean")+
  ylab("mean divergence")+
  xlab("richness")+
  theme(
    strip.background = element_rect(fill="grey90",linewidth=0),  
    # Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
     # Increase legend text and title size
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 20),
    # Increase legend key size
    legend.key.size = unit(2, "lines")) 



#single out one subplot

selection_mean_single<-filter(selection_mean,treatment=="Tmp_25_28_Nut0.01")

single_plot<-ggplot(selection_mean_single,aes(x=richness,y=mean_divergence,label=composition))+
  geom_point()+
  #geom_hline(yintercept = c(0.2, 0.4, 0.6, 0.8), color = "grey") +
  #geom_smooth(method="lm")+
  #facet_rep_grid(nutrients~temperature,scales="free_x")+
  geom_text_repel(size = 2,max.overlaps = 100)+
  #labs(title = "criteria: mean")+
  ylab("")+
  xlab("richness")+
  ylim(0,0.9)+
  #scale_y_continuous(position = "right")+
  theme(strip.background = element_blank(),  
        strip.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(margin = margin(b = 10)),
        strip.text.y = element_text(margin = margin(l = 10)),
        axis.title.y = element_text(margin = margin(r = 15)),
        axis.title.x = element_text(margin = margin(t = 15)))



# get derivatives 



get_deriv_adj<-function(nutrient_level,sp,t_range,c){
  env_range<-data.frame(temperature=seq(18,28,by=0.01))
  env_range<-mutate(env_range,nutrients=rep(nutrient_level))
  new_df<-data.frame()
  partial_df<-data.frame()
  for(i in 1:5){
    new_df<-data.frame(pd=partial_derivatives(new_nested_gams$gams[[i]],data=env_range,type = "central",focal = "temperature")$partial_deriv)
  new_df<-mutate(new_df,species=rep(new_nested_gams$species[i]),temperature=env_range$temperature)
  partial_df<-rbind(partial_df,new_df)
 }

  partial_df<-filter(partial_df,species%in% sp)

  
  
endpoints<-filter(partial_df,temperature%in%t_range)
  
  
partial_Nut2<-ggplot(data=partial_df,aes(x=temperature,y=pd,color=species))+
  geom_line()+
  scale_color_manual(values=c)+
  #scale_color_brewer(palette = "Dark2")+
  #geom_vline(xintercept = c(22, 24.95), linetype = "dotted", color =    "black")+
  #xlab("")+
  geom_hline(yintercept = 0, linetype = "dashed", color =    "grey")+
  #geom_vline(xintercept = c(25.05, 28), color = "black")+
  #labs(title = paste("nutrient concentration",nutrient_level,"mg/L"))+
  geom_point(data=endpoints,aes(x=temperature,y=pd))


}


dn_1_DS<-get_deriv_adj(0.01,sp=c("Dexiostoma","Spirostomum"),t_range=c(25,28),c=color_sp[c(2,5)])
dn_1_DS<-dn_1_DS+xlim(24.5,28)+ylim(-0.035,0.035)+ylab("")+xlab("")+
  theme(axis.title.y = element_text(margin = margin(r = 20)),
        legend.position = "none")
dn_1_DS <- dn_1_DS +
  #annotate("text", x = 25, y = 0.04, label = "DS", size = 3, color = "black")+
  annotate("text",x = 25.5,  y = 0.028, label = "divergence = 0.82", size = 3, color = "black")

dn_1_CD<-get_deriv_adj(0.01,sp=c("Colpidium","Dexiostoma"),t_range=c(25,28),c=color_sp[c(1,2)])
dn_1_CD<-dn_1_CD+xlim(24.5,28)+ylim(-0.075,0.075)+ylab("")+xlab("")+
  theme(axis.title.y = element_text(margin = margin(r = 20)),
        legend.position = "none")
dn_1_CD <- dn_1_CD +
  #annotate("text", x = 25, y = 0.1, label = "CD", size = 3, color = "black")+
  annotate("text",x = 25.5, y = 0.06, label = "divergence = 0.30", size = 3, color = "black")

dn_1_LS<-get_deriv_adj(0.01,sp=c("Loxocephalus","Spirostomum"),t_range=c(25,28),c=color_sp[c(3,5)])
dn_1_LS<-dn_1_LS+xlim(24.5,28)+ylim(-0.4,0.4)+ylab("")+xlab("")+
  theme(axis.title.y = element_text(margin = margin(r = 20)),
        axis.title.x = element_text(margin = margin(t = 15)),
        legend.position ="none")
dn_1_LS <- dn_1_LS +
  #annotate("text", x = 25, y = 0.5, label = "LS", size = 3, color = "black")+
  annotate("text",x = 25.5, y = 0.32, label = "divergence = 0.00", size = 3, color = "black")


fig_plot<-get_deriv_adj(0.01,sp=c("Colpidium","Spirostomum","Dexiostoma","Loxocephalus"),t_range=c(25,28),c=color_sp[c(1,2,3,5)])

legend<-fig_plot+
  theme(legend.position = "top", legend.direction = "horizontal",legend.key.size = unit(0.3,"cm"),legend.title = element_text(hjust = 0.5, margin = margin(b = 5)))+guides(colour = guide_legend(title.position = "top")) 



fig1<-ggarrange(dn_1_DS,dn_1_CD,dn_1_LS,ncol=1,common.legend=F,align = "v"#,legend.grob = get_legend(legend),align = "v",legend="top"
)


fig1<-annotate_figure(fig1,
                      left=text_grob("directional derivative",size=11,rot=90,vjust=3))

#single_plot2<-annotate_figure(single_plot,
#                    left=text_grob("mean divergence",size=11,rot=90,vjust=3))


single_plot1<-single_plot+annotate("text",x = 2, y = 0.9, label = "temperature = 25-28 Â°C", size = 3, color = "black",hjust=0)+
  annotate("text", x = 2, y = 0.88, label = "nutrients = 0.01 g/L", size = 3, color = "black",hjust=0)



fig1<-ggarrange(mean_plot,single_plot1,fig1,ncol=3,labels=c("E","F","G"))
```






## figure2 ggplot

```{r}

s2d_plots <- list()

for (i in seq_along(new_nested_gams$gams)) {
 species_name <- new_nested_gams$species[i]
 df<-filter(rates,species==species_name)
 col<-color_sp[i]
 
surface_2d<-ggplot(data=df,aes(x=temperature,y=nutrients,fill=predicted))+
  geom_raster()+
  scale_fill_gradient(high=col, low="white",guide = "none")+
  #guides(fill = guide_colorbar(title = "", title.position = "top", 
    #                           direction = "vertical", barwidth =                                    2,barheight = 5,frame.colour = "black"))+
  geom_contour(data=df,aes(x=temperature,y=nutrients,z=predicted),color = "grey40", linetype = "solid", bins=11)+
  scale_x_continuous(breaks = seq(18, 28, by = 2))+
   theme(strip.background = element_blank(),  
        strip.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(margin = margin(b = 10)),
        strip.text.y = element_text(margin = margin(l = 10)),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "right",  
        legend.direction = "vertical",aspect.ratio = 1,
        legend.key.height = unit(0.3, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.key.size = unit(0.5,"cm"))+
  labs(title=species_name,fill="")+
  geom_segment(data = data.frame(y = c(0.01, 0.01), x = c(25, 25), 
                                 xend = c(28, 28),  yend = c(0.01, 0.01)), 
               aes(x, y, xend = xend, yend = yend),
               inherit.aes = FALSE, linetype = 1)+
  geom_point(data=data.frame(x=c(25,28),y=c(0.01,0.01)),aes(x=x,y=y),inherit.aes = FALSE)
  
  

  
 # Save the plot in the list
  s2d_plots[[species_name]] <- surface_2d

}


s_dexiostoma <- s2d_plots[["Dexiostoma"]]
s_colpidium <- s2d_plots[["Colpidium"]]
s_loxocephalus <- s2d_plots[["Loxocephalus"]]
s_paramecium <- s2d_plots[["Paramecium"]]
s_spirostotum <- s2d_plots[["Spirostomum"]]

library(ggplot2) 
library(grid)
library(gridExtra) 

legend_spir <- cowplot::get_legend(s_spirostotum)



legend_dexi <- cowplot::get_legend(s_dexiostoma)
legend_colp <- cowplot::get_legend(s_colpidium)
legend_loxo <- cowplot::get_legend(s_loxocephalus)
legend_para <- cowplot::get_legend(s_paramecium)

legends<-ggarrange(legend_spir,legend_dexi,legend_colp,legend_loxo,legend_para,nrow=2,ncol=3)

legends<-annotate_figure(legends,
                         top=text_grob("growth rate",size=15,vjust=1,hjust=1.3))


fig2<-ggarrange(legends,s_dexiostoma,s_loxocephalus,s_paramecium,s_spirostotum,s_colpidium,common.legend=F,nrow=3,ncol=2,align="hv")


fig2<-annotate_figure(fig2,
                      left=text_grob("nutrients [g/L]",size=11,rot=90,vjust=0.9),bottom=text_grob("temperature [Â°C]"))





Tplot <- ggplot(env_data_2, aes(x = time, y = temperature)) +
  geom_line(color = "red") +
  labs( y = "temperature [Â°C]")+
  ylim(21, 26) +
  xlim(0,50)+
   theme(strip.background = element_blank(),  
        strip.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(margin = margin(b = 10)),
        strip.text.y = element_text(margin = margin(l = 10)),
        axis.title.y = element_text(margin = margin(r = 15)),
        axis.title.x = element_blank())
   
   
Nplot <- ggplot(filter(env_data_2,nutrients==0.75), aes(x = time, y = nutrients)) +
  geom_line(color = "blue") +
  labs( y = "nutrients [g/L]")+
  ylim(0,3)+
  xlim(0,50)+
   theme(strip.background = element_blank(),  
        strip.text = element_text(size = 10, color = "black"),
        strip.text.x = element_text(margin = margin(b = 10)),
        strip.text.y = element_text(margin = margin(l = 10)),
        axis.title.y = element_text(margin = margin(r = 15)),
        axis.title.x = element_blank())

env_plot<-ggarrange(Tplot,Nplot,ncol=2,nrow=1)


env_plot<-annotate_figure(env_plot,
                      bottom=text_grob("time [days]"))


fig2_c<-ggarrange(n_2,dn_2,env_plot,ncol=1,nrow=3,heights=c(2,2,1))

fig2_f<-ggarrange(fig2,fig2_c)


```




## fig3
```{r}

fig3a<-ggarrange(s_dexiostoma,s_loxocephalus,s_paramecium,s_spirostotum,s_colpidium,legends,common.legend=F,nrow=2,ncol=3,align="hv")+
  theme(plot.margin = margin(0.1,0.1,0.1,1.5, "cm")) 



fig3a<-annotate_figure(fig3a,bottom=text_grob("temperature [Â°C]",size=15),
                       left=text_grob("nutrients [g/L]",size=15,vjust=2,rot=90))

n_1a<-n_1+annotate("text",x = 25.1, y = 0.9, label = "temperature: 25-28 Â°C", size = 3, color = "black",hjust=0)+
  annotate("text",x = 25.1, y = 0.75, label = "nutrients: 0.01 g/L", size = 3, color = "black",hjust=0)


fig3b<-ggarrange(n_1a,dn_1,ncol=1,nrow=2)

fig3b<-ggarrange(fig3b,labels=c("B"),font.label = list(size=20),label.x=-0.01)

fig3c<-ggarrange(dn_1_LS+ylab("directional derivative"),dn_1_CD+xlab("temperature [Â°C]"),dn_1_DS,ncol=3,nrow=1,align="h")




```

#supplementary figure



```{r}

s1<-ggplot(data=selection_mean,aes(x=as.factor(richness),y=mean_divergence))+
  geom_boxplot()+
  geom_jitter(width=0.1)


dd_fig<-dd
dd_fig$nutrients[dd_fig$nutrients==1]<-0.01
dd_fig$nutrients[dd_fig$nutrients==2]<-0.75
dd_fig$nutrients[dd_fig$nutrients==3]<-1.25
dd_fig$nutrients[dd_fig$nutrients==4]<-2.50
dd_fig$nutrients[dd_fig$nutrients==5]<-3.00

dd_fig$temperature[dd_fig$temperature==18]<-"18 Â°C"
dd_fig$temperature[dd_fig$temperature==21]<-"21 Â°C"
dd_fig$temperature[dd_fig$temperature==24]<-"24 Â°C"
dd_fig$temperature[dd_fig$temperature==26]<-"26 Â°C"
dd_fig$temperature[dd_fig$temperature==28]<-"28 Â°C"

dd_fig$day[dd$day==6]<-7
dd_fig$day[dd$day==7]<-9
dd_fig$day[dd$day==8]<-11
dd_fig$day[dd$day==9]<-14
dd_fig$day[dd$day==10]<-16
dd_fig$day[dd$day==11]<-18

plot_regression_day <- ggplot(dd_fig, aes(x = day, y = log10(density), color = as.factor(nutrients))) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE) +
  scale_x_continuous(breaks = seq(1,18,by=2))+
  #geom_smooth(data = dd %>% filter(day <= 6, species != "Spirostomum" & species != "Colpidium"&species != "Colpidium"), method = "lm", se = FALSE, aes(group = nutrients, color = factor(nutrients)), linewidth = 1.5) +  # LM line for days <= 5
  #geom_smooth(data = dd %>% filter(species == "Spirostomum"), method = "lm", se = FALSE, aes(group = nutrients, color = factor(nutrients)), linewidth = 1.5) +  # LM line for Spirostomum across all days
  scale_color_viridis_d(option = "magma",begin=0,end=0.8) +
  facet_grid(temperature~ species, scales = "free")+
   theme(
    strip.background = element_rect(fill="grey90",linewidth=0),  
    # Increase facet text size
    strip.text = element_text(size = 20),
    # Increase axis text size
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    # Increase axis title size
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
     # Increase legend text and title size
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 20),
    # Increase legend key size
    legend.key.size = unit(2, "lines")  # Adjust the size as needed
  )+ylab(expression( log(density) ~ "["~ mL^-1 ~ "]" ))+labs(color="nutrients [g/L]")


strings<-c()

for (i in selection_mean$composition){
  s<-str_split_1(i,pattern="")
  
  strings<-append(strings,s)
  
}

strings=="C"

count_sp<-data.frame(Colpidium=sum(strings=="C"),
             Dexiostoma=sum(strings=="D"),
             Spirostomum=sum(strings=="S"),
             Paramecium=sum(strings=="P"),
             Loxocephalus=sum(strings=="L"))


```

